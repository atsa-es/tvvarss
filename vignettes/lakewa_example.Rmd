---
title: "Applying tvvarss to Lake Washington Data"
author: "Eric Ward, Mark Scheuerell, Steve Katz"
date: "Apr 3, 2017"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tvvarss}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

## Installation

```{r, eval=FALSE}
library(devtools)
devtools::install_github("eric-ward/tvvarss")
```

```{r install, results="hide"}
library(knitr)
library(rstan)
library(tvvarss)
# for optimizing stan on your machine,
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

## Data
We are using the existing data in the `MARSS` package.

```{r}
library(MARSS)
data(lakeWAplankton)
lakeWAplankton = lakeWAplanktonRaw[,c("Diatoms", "Greens", "Bluegreens", "Daphnia", "Cyclops", "Diaptomus", "Non.daphnid.cladocerans")]
head(lakeWAplankton)
```

Hampton et al. (2006) used 2 food web configurations, a simple model with 7 species groups (representing those hypothesized to be most important), and another with 13 species groups.

We replicate the analysis of Hampton et al. 2006 with the following 7 species,

```{r, echo=FALSE}
m = matrix("", 7, 1)
m[,1] = c("Diatoms","Greens","Bluegreens","Cyclops","Daphnia","Diaptomus","Non-daphnid cladocerans")
colnames(m) = "Species"
kable(m)
```

Several differences between our analysis of this food web and those presented by Hampton et al. 2006 are  
(1) We use a state - space model, in place of the MAR model used by Hampton  
(2) Missing values in our analysis are treated as NAs rather than interpolated  
(3) For simplicity, we're not including the effects of external covariates  
(4) We allow interactions to be time - varying, while in the MAR model used by Hampton et al. (2006) these are static  

Like Hampton et al. 2006, we used monthly samples 1962-1994, and we replaced zeros in this data with small random values between zero and half the smallest value observed per taxa. Resulting values were log-transformed to achieve approximate normality.

```{r}
for(i in 1:ncol(lakeWAplankton)) {
  zeros = which(lakeWAplankton[,i]==0)
  lakeWAplankton[zeros,i] = runif(n = length(zeros), min = 0, max = 0.5 * min(lakeWAplankton[,i], na.rm=T))
}

# log transform
lakeWAplankton_log = log(lakeWAplankton)
```

## Specifying matrix of interactions
We'll adopt the same constraints on the B matrix used by Hampton et al. (2006) in which elements are estimated versus set to zero. We will constrain elements on the diagonal to be positive (representing density dependence), but do not impose constraints on the other estimated values. 

```{r bmatrix}
B = matrix("zero", ncol(lakeWAplankton_log), ncol(lakeWAplankton_log))
diag(B) = "dd"
B[1,3] = "cf"
B[4,c(5,7)] = "cf"
B[5,c(1,3)] = "cf"
B[6,c(1,5,7)] = "cf"
B[7,c(1,5)] = "cf"
```


## Fitting

```{r, eval = FALSE}
B = B0_lfc

stanmod = tvvarss(y = dat_obs, include_trend = FALSE, de_mean = TRUE, x0 = NULL, shared_q = NULL, shared_r = NULL, shared_u = NULL, mcmc_iter = 1000, mcmc_warmup = 500, mcmc_thin = 1, mcmc_chain = 3)
```

## Validation

```{r, eval = FALSE}
pred = apply(extract(stanmod, c("pred"))$pred, c(3,4), mean)

par(mfrow = c(2,2), mgp=c(2,1,0), mai=c(0.3,0.3,0.1,0.1))
for(i in 1:4) {
  plot(pred[,i], type="l", ylim=range(c(dat_obs[,i], pred[,i])))
  points(dat_obs[,i], col="red")
}
```


