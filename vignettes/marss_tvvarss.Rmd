---
title: "MARSS_tvvarss"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tvvarss)
library(MARSS)
library(rstan)
library(knitr)
```

# Simulating some data
I just created a 2x2 B matrix using Mark's simulation set up, and discarded the burn-in portion of the time series. This gives us some stationary time series,

```{r, echo=FALSE}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

n_species <- 2
n_year <- 200
n_site <- 1

## topo matrix for linear food chain
B0_lfc <- matrix(list(0),n_species,n_species)
diag(B0_lfc) <- "dd"
for(i in 1:(n_species-1)) {
  B0_lfc[i,i+1] <- "zero"
  B0_lfc[i+1,i] <- "zero"
}

## initial B
B0_init <- matrix(0,n_species,n_species)
diag(B0_init) <- c(0.8,0.6)
B0_init[1,2] <- 0
B0_init[2,1] <- 0

set.seed(1)
## simulate process
  lfc <- simTVVAR(Bt = B0_init,
                  topo = B0_lfc,
                  TT = n_year,
                  var_QX = 0.0001,
                  cov_QX = 0,
                  var_QB = 0,
                  cov_QB = 0)

  ## add very small obs error
  Y <- sim2fit(lfc, n_site, sd=0.0001)

  # drop burn-in
  yy = Y[1,-c(1:100),]
  
  # de-mean the data
  yy[,1] = yy[,1] - mean(yy[,1])
  yy[,2] = yy[,2] - mean(yy[,2])  
  matplot(yy)
```

The B matrix that generated this data looks like this, 
```{r, echo=FALSE}
kable(B0_init, caption="B matrix used in simulations")
```

and topo matrix is 

```{r, echo=FALSE}
kable(B0_lfc, caption="Topo matrix used in simulations")
```

\break
  
## MARSS estimation

We can fit a MARSS model to these data to recover B, 

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
B = MARSS(t(yy), model=list("B" = matrix(list("b11",0,0,"b22"),2,2), "U"="zero"))$par$B
```

```{r, echo=FALSE}
kable(matrix(B, 2,2), caption="MARSS estimates")
```


\break  
  
## TVVARSS estimation

First, we can fit the same model as MARSS, with a static B

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
marss_constrained <- tvvarss(y=yy, topo=B0_lfc, shared_r = matrix(1, n_species, n_site), mcmc_chain=1, mcmc_iter=3000, mcmc_warmup=2000, dynamicB = FALSE, de_mean=TRUE)



```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(round(apply(extract(marss_constrained, "B")$B, c(2,3,4), mean)[1,,], 3), caption="TVARSS estimated B matrix")
```

To see if our constraints via the topo matrix are making things weird, we can also do another run where these are relaxed,

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# Change up constraints on B matrix
  B0_lfc[1,2] = "cf"
  B0_lfc[2,1] = "cf"
  ## fit model to only 2nd half of data & save param summaries
  marss_unconstrained <- tvvarss(y=yy, topo=B0_lfc, shared_r = matrix(1, n_species, n_site),
    mcmc_chain=1, mcmc_iter=3000, mcmc_warmup=2000, dynamicB = FALSE, de_mean=TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(round(apply(extract(marss_unconstrained, "B")$B, c(2,3,4), mean)[1,,], 3), caption="TVARSS estimated B matrix -- unconstrained")
```


simdata = MARSSsimulate(mod, tSteps = 100)$sim.data[,,1]
simdata[1,] = simdata[1,] - mean(simdata[1,])
simdata[2,] = simdata[2,] - mean(simdata[2,])
MARSS(simdata, model=list("B" = "unconstrained", "U"="zero"))$par$B
